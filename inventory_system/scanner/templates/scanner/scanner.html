<!DOCTYPE html>
<html>
<head>
    <title>Live Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <h1>Live Barcode Scanner</h1>
    <div id="reader" style="width:500px;"></div>
    <div id="result"></div>
    <div id="error" style="color:red;"></div>

    <script>
        function onScanSuccess(decodedText, decodedResult) {
            fetch('/scan/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'barcode=' + encodeURIComponent(decodedText)
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    document.getElementById('result').innerHTML =
                        `Scanned: ${data.barcode}, Name: ${data.name}, Quantity: ${data.quantity}`;
                } else {
                    document.getElementById('error').innerText = "Error: " + data.error;
                }
            })
            .catch(err => {
                document.getElementById('error').innerText = "Fetch error: " + err;
            });
        }

        function onScanFailure(error) {
            console.warn(`Scan failure: ${error}`);
        }

        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length) {
                let cameraId = cameras[0].id;
                let html5QrcodeScanner = new Html5Qrcode("reader");
                html5QrcodeScanner.start(
                    cameraId,
                    { fps: 10, qrbox: 250 },
                    onScanSuccess,
                    onScanFailure
                ).catch(err => {
                    document.getElementById('error').innerText = "Could not start camera: " + err;
                });
            } else {
                document.getElementById('error').innerText = "No camera found";
            }
        }).catch(err => {
            document.getElementById('error').innerText = "Camera error: " + err;
        });
    </script>
</body>
</html>
